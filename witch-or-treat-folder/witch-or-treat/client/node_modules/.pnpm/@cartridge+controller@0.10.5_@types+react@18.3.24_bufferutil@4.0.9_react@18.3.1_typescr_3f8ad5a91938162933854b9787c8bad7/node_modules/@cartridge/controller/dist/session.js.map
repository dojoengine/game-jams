{"version":3,"file":"session.js","sources":["../src/session/account.ts","../src/session/provider.ts"],"sourcesContent":["import { Policy } from \"@cartridge/controller-wasm\";\nimport { CartridgeSessionAccount } from \"@cartridge/controller-wasm/session\";\nimport { Call, InvokeFunctionResponse, WalletAccount } from \"starknet\";\n\nimport { normalizeCalls } from \"../utils\";\nimport BaseProvider from \"../provider\";\n\nexport * from \"../errors\";\nexport * from \"../types\";\n\nexport default class SessionAccount extends WalletAccount {\n  public controller: CartridgeSessionAccount;\n\n  constructor(\n    provider: BaseProvider,\n    {\n      rpcUrl,\n      privateKey,\n      address,\n      ownerGuid,\n      chainId,\n      expiresAt,\n      policies,\n      guardianKeyGuid,\n      metadataHash,\n      sessionKeyGuid,\n    }: {\n      rpcUrl: string;\n      privateKey: string;\n      address: string;\n      ownerGuid: string;\n      chainId: string;\n      expiresAt: number;\n      policies: Policy[];\n      guardianKeyGuid: string;\n      metadataHash: string;\n      sessionKeyGuid: string;\n    },\n  ) {\n    super({\n      provider: { nodeUrl: rpcUrl },\n      walletProvider: provider,\n      address,\n    });\n\n    this.controller = CartridgeSessionAccount.newAsRegistered(\n      rpcUrl,\n      privateKey,\n      address,\n      ownerGuid,\n      chainId,\n      {\n        expiresAt,\n        policies,\n        guardianKeyGuid,\n        metadataHash,\n        sessionKeyGuid,\n      },\n    );\n  }\n\n  /**\n   * Invoke execute function in account contract\n   *\n   * @param calls the invocation object or an array of them, containing:\n   * - contractAddress - the address of the contract\n   * - entrypoint - the entrypoint of the contract\n   * - calldata - (defaults to []) the calldata\n   * - signature - (defaults to []) the signature\n   * @param abis (optional) the abi of the contract for better displaying\n   *\n   * @returns response from addTransaction\n   */\n  async execute(calls: Call | Call[]): Promise<InvokeFunctionResponse> {\n    return this.controller.execute(normalizeCalls(calls));\n  }\n}\n","import { ec, stark, WalletAccount } from \"starknet\";\n\nimport {\n  signerToGuid,\n  subscribeCreateSession,\n} from \"@cartridge/controller-wasm\";\nimport { SessionPolicies } from \"@cartridge/presets\";\nimport { AddStarknetChainParameters } from \"@starknet-io/types-js\";\nimport { encode } from \"starknet\";\nimport { KEYCHAIN_URL } from \"../constants\";\nimport { ParsedSessionPolicies } from \"../policies\";\nimport BaseProvider from \"../provider\";\nimport { toWasmPolicies } from \"../utils\";\nimport SessionAccount from \"./account\";\n\ninterface SessionRegistration {\n  username: string;\n  address: string;\n  ownerGuid: string;\n  transactionHash?: string;\n  expiresAt: string;\n  guardianKeyGuid: string;\n  metadataHash: string;\n  sessionKeyGuid: string;\n}\n\nexport type SessionOptions = {\n  rpc: string;\n  chainId: string;\n  policies: SessionPolicies;\n  redirectUrl: string;\n  keychainUrl?: string;\n  apiUrl?: string;\n};\n\nexport default class SessionProvider extends BaseProvider {\n  public id = \"controller_session\";\n  public name = \"Controller Session\";\n\n  protected _chainId: string;\n  protected _rpcUrl: string;\n  protected _username?: string;\n  protected _redirectUrl: string;\n  protected _policies: ParsedSessionPolicies;\n  protected _keychainUrl: string;\n  protected _apiUrl?: string;\n\n  constructor({\n    rpc,\n    chainId,\n    policies,\n    redirectUrl,\n    keychainUrl,\n    apiUrl,\n  }: SessionOptions) {\n    super();\n\n    this._policies = {\n      verified: false,\n      contracts: policies.contracts\n        ? Object.fromEntries(\n            Object.entries(policies.contracts).map(([address, contract]) => [\n              address,\n              {\n                ...contract,\n                methods: contract.methods.map((method) => ({\n                  ...method,\n                  authorized: true,\n                })),\n              },\n            ]),\n          )\n        : undefined,\n      messages: policies.messages?.map((message) => ({\n        ...message,\n        authorized: true,\n      })),\n    };\n\n    this._rpcUrl = rpc;\n    this._chainId = chainId;\n    this._redirectUrl = redirectUrl;\n    this._keychainUrl = keychainUrl || KEYCHAIN_URL;\n    this._apiUrl = apiUrl;\n\n    if (typeof window !== \"undefined\") {\n      (window as any).starknet_controller_session = this;\n    }\n  }\n\n  private validatePoliciesSubset(\n    newPolicies: ParsedSessionPolicies,\n    existingPolicies: ParsedSessionPolicies,\n  ): boolean {\n    if (newPolicies.contracts) {\n      if (!existingPolicies.contracts) return false;\n\n      for (const [address, contract] of Object.entries(newPolicies.contracts)) {\n        const existingContract = existingPolicies.contracts[address];\n        if (!existingContract) return false;\n\n        for (const method of contract.methods) {\n          const existingMethod = existingContract.methods.find(\n            (m) => m.entrypoint === method.entrypoint,\n          );\n          if (!existingMethod || !existingMethod.authorized) return false;\n        }\n      }\n    }\n\n    if (newPolicies.messages) {\n      if (!existingPolicies.messages) return false;\n\n      for (const message of newPolicies.messages) {\n        const existingMessage = existingPolicies.messages.find(\n          (m) =>\n            JSON.stringify(m.domain) === JSON.stringify(message.domain) &&\n            JSON.stringify(m.types) === JSON.stringify(message.types),\n        );\n        if (!existingMessage || !existingMessage.authorized) return false;\n      }\n    }\n\n    return true;\n  }\n\n  async username() {\n    await this.tryRetrieveFromQueryOrStorage();\n    return this._username;\n  }\n\n  async probe(): Promise<WalletAccount | undefined> {\n    if (this.account) {\n      return this.account;\n    }\n\n    this.account = await this.tryRetrieveFromQueryOrStorage();\n    return this.account;\n  }\n\n  async connect(): Promise<WalletAccount | undefined> {\n    if (this.account) {\n      return this.account;\n    }\n\n    this.account = await this.tryRetrieveFromQueryOrStorage();\n    if (this.account) {\n      return this.account;\n    }\n\n    const pk = stark.randomAddress();\n    const publicKey = ec.starkCurve.getStarkKey(pk);\n\n    localStorage.setItem(\n      \"sessionSigner\",\n      JSON.stringify({\n        privKey: pk,\n        pubKey: publicKey,\n      }),\n    );\n\n    localStorage.setItem(\"sessionPolicies\", JSON.stringify(this._policies));\n\n    const url = `${\n      this._keychainUrl\n    }/session?public_key=${publicKey}&redirect_uri=${\n      this._redirectUrl\n    }&redirect_query_name=startapp&policies=${JSON.stringify(\n      this._policies,\n    )}&rpc_url=${this._rpcUrl}`;\n\n    localStorage.setItem(\"lastUsedConnector\", this.id);\n    const openedWindow = window.open(url, \"_blank\");\n\n    try {\n      const formattedPk = encode.addHexPrefix(pk);\n\n      const sessionKeyGuid = signerToGuid({\n        starknet: { privateKey: formattedPk },\n      });\n\n      const cartridgeApiUrl = this._apiUrl ?? \"https://api.cartridge.gg\";\n      const sessionResult = await subscribeCreateSession(\n        sessionKeyGuid,\n        cartridgeApiUrl,\n      );\n\n      // auth is: [shortstring!('authorization-by-registered'), owner_guid]\n      const ownerGuid = sessionResult.authorization[1];\n      const session: SessionRegistration = {\n        username: sessionResult.controller.accountID,\n        address: sessionResult.controller.address,\n        ownerGuid,\n        expiresAt: sessionResult.expiresAt,\n        guardianKeyGuid: \"0x0\",\n        metadataHash: \"0x0\",\n        sessionKeyGuid,\n      };\n      localStorage.setItem(\"session\", JSON.stringify(session));\n\n      this.tryRetrieveFromQueryOrStorage();\n\n      openedWindow?.close();\n\n      return this.account;\n    } catch (e) {\n      console.log(e);\n    }\n  }\n\n  switchStarknetChain(_chainId: string): Promise<boolean> {\n    throw new Error(\"switchStarknetChain not implemented\");\n  }\n\n  addStarknetChain(_chain: AddStarknetChainParameters): Promise<boolean> {\n    throw new Error(\"addStarknetChain not implemented\");\n  }\n\n  disconnect(): Promise<void> {\n    localStorage.removeItem(\"sessionSigner\");\n    localStorage.removeItem(\"session\");\n    localStorage.removeItem(\"sessionPolicies\");\n    this.account = undefined;\n    this._username = undefined;\n    return Promise.resolve();\n  }\n\n  async tryRetrieveFromQueryOrStorage() {\n    if (this.account) {\n      return this.account;\n    }\n\n    const signerString = localStorage.getItem(\"sessionSigner\");\n    const signer = signerString ? JSON.parse(signerString) : null;\n    let sessionRegistration: SessionRegistration | null = null;\n\n    const sessionString = localStorage.getItem(\"session\");\n    if (sessionString) {\n      sessionRegistration = JSON.parse(sessionString);\n    }\n\n    if (window.location.search.includes(\"startapp\")) {\n      const params = new URLSearchParams(window.location.search);\n      const session = params.get(\"startapp\");\n      if (session) {\n        const possibleNewSession: SessionRegistration = JSON.parse(\n          atob(session),\n        );\n\n        if (\n          Number(possibleNewSession.expiresAt) !==\n          Number(sessionRegistration?.expiresAt)\n        ) {\n          sessionRegistration = possibleNewSession;\n          localStorage.setItem(\"session\", JSON.stringify(sessionRegistration));\n        }\n\n        // Remove the session query parameter\n        params.delete(\"startapp\");\n        const newUrl =\n          window.location.pathname +\n          (params.toString() ? `?${params.toString()}` : \"\") +\n          window.location.hash;\n        window.history.replaceState({}, document.title, newUrl);\n      }\n    }\n\n    if (!sessionRegistration || !signer) {\n      return;\n    }\n\n    // Check expiration\n    const expirationTime = parseInt(sessionRegistration.expiresAt) * 1000;\n    if (Date.now() >= expirationTime) {\n      this.clearStoredSession();\n      return;\n    }\n\n    // Check stored policies\n    const storedPoliciesStr = localStorage.getItem(\"sessionPolicies\");\n    if (storedPoliciesStr) {\n      const storedPolicies = JSON.parse(\n        storedPoliciesStr,\n      ) as ParsedSessionPolicies;\n\n      const isValid = this.validatePoliciesSubset(\n        this._policies,\n        storedPolicies,\n      );\n\n      if (!isValid) {\n        this.clearStoredSession();\n        return;\n      }\n    }\n\n    this._username = sessionRegistration.username;\n    this.account = new SessionAccount(this, {\n      rpcUrl: this._rpcUrl,\n      privateKey: signer.privKey,\n      address: sessionRegistration.address,\n      ownerGuid: sessionRegistration.ownerGuid,\n      chainId: this._chainId,\n      expiresAt: parseInt(sessionRegistration.expiresAt),\n      policies: toWasmPolicies(this._policies),\n      guardianKeyGuid: sessionRegistration.guardianKeyGuid,\n      metadataHash: sessionRegistration.metadataHash,\n      sessionKeyGuid: sessionRegistration.sessionKeyGuid,\n    });\n\n    return this.account;\n  }\n\n  private clearStoredSession(): void {\n    localStorage.removeItem(\"sessionSigner\");\n    localStorage.removeItem(\"session\");\n    localStorage.removeItem(\"sessionPolicies\");\n  }\n}\n"],"names":["SessionAccount","WalletAccount","provider","rpcUrl","privateKey","address","ownerGuid","chainId","expiresAt","policies","guardianKeyGuid","metadataHash","sessionKeyGuid","CartridgeSessionAccount","calls","normalizeCalls","SessionProvider","BaseProvider","rpc","redirectUrl","keychainUrl","apiUrl","contract","method","message","KEYCHAIN_URL","newPolicies","existingPolicies","existingContract","existingMethod","m","existingMessage","pk","stark","publicKey","ec","url","openedWindow","formattedPk","encode","signerToGuid","cartridgeApiUrl","sessionResult","subscribeCreateSession","session","e","_chainId","_chain","signerString","signer","sessionRegistration","sessionString","params","possibleNewSession","newUrl","expirationTime","storedPoliciesStr","storedPolicies","toWasmPolicies"],"mappings":"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"}