import{getComponentValue as w,hasComponent as v,removeComponent as O,setComponent as x,updateComponent as $}from"@dojoengine/recs";import{Type as s}from"@dojoengine/recs";function y(e,r){return Object.keys(e).reduce((t,n)=>{let a=e[n],o=r[n];if(o===void 0)return t;if(o==null)return t[n]=o,t;if(o.type==="enum")if(o.type_name&&o.type_name.includes("Option")){if(o.value.option==="None")return t[n]=null,t;a=S(a),o=o.value.value}else return t[n]=o.value.option,t;switch(a){case s.StringArray:t[n]=h(o);break;case s.String:t[n]=o.value;break;case s.BigInt:t[n]=E(o.value);break;case s.Boolean:t[n]=o.value;break;case s.Number:t[n]=Number(o.value);break;default:t[n]=C(a,o);break}return t},{})}function S(e){switch(e){case s.OptionalNumber:return s.Number;case s.OptionalBigInt:return s.BigInt;case s.OptionalString:return s.String;case s.OptionalNumberArray:return s.NumberArray;case s.OptionalBigIntArray:return s.BigIntArray;case s.OptionalStringArray:return s.StringArray;case s.OptionalEntity:return s.Entity;case s.OptionalEntityArray:return s.EntityArray;case s.OptionalT:return s.T;default:return e}}function h(e){return e.type==="array"&&e.value.length===0?[]:e.type==="array"&&e.value[0]?.type==="enum"?e.value.map(r=>r.value.option):e.value.map(r=>{try{return BigInt(r.value)}catch{return r.value}})}function E(e){if(typeof e=="bigint")return e;try{return BigInt(e)}catch{console.warn(`Failed to convert ${e} to BigInt. Attempting hexadecimal conversion.`);try{return BigInt(`0x${e}`)}catch{return console.warn(`Failed to convert 0x${e} to BigInt. Using string value instead.`),e}}}function C(e,r){if(typeof e=="object"&&r.type==="struct")if(r.value instanceof Map){let t=Object.fromEntries(r.value);return y(e,t)}else return typeof r.value=="object"?y(e,r.value):(console.warn(`Expected value.value to be a Map or object for struct type, got ${typeof r.value}.`),r.value);return Array.isArray(e)&&r.type==="array"?r.value.map(t=>y(e[0],t)):r.value}var D=async(e,r,t,n=[],a=[],o=100,i=!1)=>(i&&console.log("Starting getSyncEntities ",t),await j(e,t,r,n,a,o,i),await _(e,r,t,i)),R=async(e,r,t,n=[],a=[],o=100,i=!1,l=!0,u)=>(i&&console.log("Starting getSyncEvents"),await B(e,r,n,a,o,t,i,l,u),await T(e,r,t,i)),j=async(e,r,t,n=[],a=[],o=100,i=!1,l=!1,{dbConnection:u,timestampCacheKey:d}={dbConnection:void 0,timestampCacheKey:""})=>{i&&console.log("Starting getEntities");let c,f=!0;for(;f;){let m=await e.getEntities({pagination:{limit:o,cursor:c,direction:"Forward",order_by:n},clause:r||void 0,no_hashed_keys:!1,models:a,historical:l});u&&await g(u,m.items),i&&console.log("Fetched entities",m.items),p(m.items,t,i),Object.keys(m.items).length<o?f=!1:c=m.next_cursor}if(u){let m=Math.floor(Date.now()/1e3);M(m,d)}},B=async(e,r,t=[],n=[],a=100,o,i=!1,l=!1,u)=>{i&&console.log("Starting getEvents");let d,c=!0;for(;c;){let f=await e.getEventMessages({pagination:{limit:a,cursor:d,direction:"Forward",order_by:t},clause:o||void 0,no_hashed_keys:!1,models:n,historical:l});if(i&&console.log("entities",f.items),p(f.items,r,i),f.items.length<a&&!f.next_cursor){c=!1;continue}Object.keys(f.items).length===0?(console.error("STOP FETCHING"),c=!1):(console.error("NEXT_CURSOR",f.next_cursor),d=f.next_cursor)}u&&u()},P=async(e,r,t,n=[],a=[],o=1e3,i=!1,l=!1)=>{i&&console.log("Starting getEntitiesQuery");let u,d=!0;for(;d;){let c=await e.getEntities({pagination:{limit:o,cursor:u,direction:"Forward",order_by:n},clause:t,no_hashed_keys:!1,models:a,historical:l});if(i&&console.log(`Fetched ${Object.keys(c.items).length} entities ${c.next_cursor}`),p(c.items,r,i),c.items.length<o&&!c.next_cursor){d=!1;continue}Object.keys(c.items).length<o?d=!1:u=c.next_cursor}},_=async(e,r,t,n=!0)=>(n&&console.log("Starting syncEntities"),await e.onEntityUpdated(t,(a,o)=>{n&&console.log("Entity updated",a),p({[a]:o},r,n)})),T=async(e,r,t,n=!1)=>(n&&console.log("Starting syncEvents"),await e.onEventMessageUpdated(t,(a,o)=>{n&&console.log("Event message updated",a),p({[a]:o},r,n)}));async function b(e,r,t,n){for(let a in r){if(!Object.hasOwn(r,a))continue;let o=Object.values(t).find(i=>`${i.metadata?.namespace}-${i.metadata?.name}`===a);if(!o){n&&console.warn(`Component ${a} not found in provided components for entity ${e}.`);continue}try{let i=r[a];if(i&&typeof i=="object"&&Object.keys(i).length===0){O(o,e,{skipUpdateStream:!1}),n&&console.log(`Removed component ${o.metadata?.name} on ${e}`);continue}n&&console.log(`Raw value for ${a} on ${e}:`,i);let l=y(o.schema,i);if(n&&console.log(`Converted value for ${a} on ${e}:`,l),l==null){console.error(`convertValues returned null or undefined for ${a} on ${e}. Raw value:`,i);continue}v(o,e)?($(o,e,l,w(o,e)),n&&console.log(`Updated component ${o.metadata?.name} on ${e}`)):(x(o,e,l),n&&console.log(`Set component ${o.metadata?.name} on ${e}`))}catch(i){console.warn(`Failed to set component ${o.metadata?.name} on ${e}`,i)}}}var p=async(e,r,t=!1)=>{if(t&&console.log("Initial input to setEntities:",e),!e){t&&console.warn("Null or undefined input to setEntities.");return}if(Array.isArray(e)){if(e.length===0){t&&console.warn("Empty array passed to setEntities.");return}t&&console.log("Processing input as an array of ToriiEntity models.");for(let n of e)n&&typeof n.hashed_keys=="string"&&n.models&&typeof n.models=="object"?await b(n.hashed_keys,n.models,r,t):t&&console.warn("Skipping invalid entity model in array:",n)}else if(typeof e=="object"&&e!==null){if(Object.keys(e).length===0){t&&console.warn("Empty object passed to setEntities.");return}t&&console.log("Processing input as Record<EntityId, ComponentMap>.");for(let n in e)if(Object.hasOwn(e,n)){let a=e[n].models;typeof a=="object"&&a!==null?await b(n,a,r,t):t&&console.warn(`Data for entity ${n} is not a valid components map:`,a)}}else t&&console.warn("Invalid input type for setEntities:",e)},M=(e,r)=>{let t=Math.floor(e).toString();localStorage.setItem(r,t)};async function g(e,r){return new Promise((t,n)=>{let a=e.transaction(["entities"],"readwrite"),o=a.objectStore("entities"),i=0,l=null;a.oncomplete=()=>{l?n(l):t()},a.onerror=()=>{n(a.error)};for(let[u,d]of Object.entries(r)){let c={id:u,...d},f=o.put(c);i++,f.onerror=()=>{l=f.error}}})}export{D as a,R as b,j as c,B as d,P as e,_ as f,T as g,p as h};
//# sourceMappingURL=chunk-RSB3PDZA.js.map