#!/usr/bin/env node

// src/cli/compile-abi.ts
import { readFileSync, writeFileSync, readdirSync, existsSync } from "fs";
import { join } from "path";
function generateAbiTypes(dojoRoot) {
  const inputPath = join(dojoRoot, "compiled-abi.json");
  const outputPath = join(dojoRoot, "compiled-abi.ts");
  try {
    const abiContent = readFileSync(inputPath, "utf-8");
    const abiJson = JSON.parse(abiContent);
    const tsContent = `// This file is auto-generated from compiled-abi.json
// Do not edit manually

export const compiledAbi = ${JSON.stringify(abiJson, null, 2)} as const;

export type CompiledAbi = typeof compiledAbi;
`;
    writeFileSync(outputPath, tsContent);
    console.log(`\u2705 Generated TypeScript types!`);
    console.log(`\u{1F4C4} Output written to: ${outputPath}`);
    console.log(`
Usage in your code:`);
    console.log(`
import { compiledAbi } from './compiled-abi';`);
    console.log(`import { ExtractAbiTypes } from '@dojoengine/core';`);
    console.log(`
type MyAbi = ExtractAbiTypes<typeof compiledAbi>;`);
    console.log(
      `type Position = MyAbi["structs"]["dojo_starter::models::Position"];`
    );
  } catch (error) {
    console.error(`Error generating types: ${error}`);
    process.exit(1);
  }
}
function collectAbis(generateTypes2) {
  const dojoRoot = process.env.DOJO_ROOT || process.cwd();
  const dojoEnv = process.env.DOJO_ENV || "dev";
  const manifestPath = join(dojoRoot, `manifest_${dojoEnv}.json`);
  const targetDir = join(dojoRoot, "target", dojoEnv);
  const allAbis = [];
  if (!existsSync(manifestPath)) {
    console.error(`Manifest file not found: ${manifestPath}`);
    process.exit(1);
  }
  try {
    const manifestContent = readFileSync(manifestPath, "utf-8");
    const manifest = JSON.parse(manifestContent);
    if (manifest.world?.abi) {
      allAbis.push(...manifest.world.abi);
    }
    if (manifest.contracts) {
      for (const contract of manifest.contracts) {
        if (contract.abi) {
          allAbis.push(...contract.abi);
        }
      }
    }
  } catch (error) {
    console.error(`Error reading manifest file: ${error}`);
    process.exit(1);
  }
  if (!existsSync(targetDir)) {
    console.warn(`Target directory not found: ${targetDir}`);
  } else {
    try {
      const files = readdirSync(targetDir).filter(
        (file) => file.endsWith(".json")
      );
      for (const file of files) {
        const filePath = join(targetDir, file);
        try {
          const fileContent = readFileSync(filePath, "utf-8");
          const targetFile = JSON.parse(fileContent);
          if (targetFile.abi) {
            allAbis.push(...targetFile.abi);
          }
        } catch (error) {
          console.error(`Error reading file ${file}: ${error}`);
        }
      }
    } catch (error) {
      console.error(`Error reading target directory: ${error}`);
    }
  }
  const output = {
    abi: allAbis
  };
  const outputPath = join(dojoRoot, "compiled-abi.json");
  writeFileSync(outputPath, JSON.stringify(output, null, 2));
  console.log(`\u2705 ABI compilation complete!`);
  console.log(`\u{1F4C4} Output written to: ${outputPath}`);
  console.log(`\u{1F4CA} Total ABI entries: ${allAbis.length}`);
  if (generateTypes2) {
    generateAbiTypes(dojoRoot);
  }
}
var args = process.argv.slice(2);
var generateTypes = args.includes("--generate-types");
try {
  collectAbis(generateTypes);
} catch (error) {
  console.error(`Unexpected error: ${error}`);
  process.exit(1);
}
//# sourceMappingURL=compile-abi.js.map