{"version":3,"sources":["../../src/cli/compile-abi.ts"],"sourcesContent":["#!/usr/bin/env node\n\nimport { readFileSync, writeFileSync, readdirSync, existsSync } from \"fs\";\nimport { join } from \"path\";\n\ntype AbiEntry = {\n    [key: string]: any;\n};\n\ntype ManifestContract = {\n    abi?: AbiEntry[];\n    [key: string]: any;\n};\n\ntype Manifest = {\n    world?: {\n        abi?: AbiEntry[];\n        [key: string]: any;\n    };\n    contracts?: ManifestContract[];\n    [key: string]: any;\n};\n\ntype TargetFile = {\n    abi?: AbiEntry[];\n    [key: string]: any;\n};\n\n/**\n * Generate a TypeScript file from compiled-abi.json with proper const assertions\n * This allows TypeScript to extract literal types from the ABI\n */\nfunction generateAbiTypes(dojoRoot: string): void {\n    const inputPath = join(dojoRoot, \"compiled-abi.json\");\n    const outputPath = join(dojoRoot, \"compiled-abi.ts\");\n\n    try {\n        // Read the compiled ABI\n        const abiContent = readFileSync(inputPath, \"utf-8\");\n        const abiJson = JSON.parse(abiContent);\n\n        // Generate TypeScript content\n        const tsContent = `// This file is auto-generated from compiled-abi.json\n// Do not edit manually\n\nexport const compiledAbi = ${JSON.stringify(abiJson, null, 2)} as const;\n\nexport type CompiledAbi = typeof compiledAbi;\n`;\n\n        // Write the TypeScript file\n        writeFileSync(outputPath, tsContent);\n\n        console.log(`âœ… Generated TypeScript types!`);\n        console.log(`ðŸ“„ Output written to: ${outputPath}`);\n        console.log(`\\nUsage in your code:`);\n        console.log(`\\nimport { compiledAbi } from './compiled-abi';`);\n        console.log(`import { ExtractAbiTypes } from '@dojoengine/core';`);\n        console.log(`\\ntype MyAbi = ExtractAbiTypes<typeof compiledAbi>;`);\n        console.log(\n            `type Position = MyAbi[\"structs\"][\"dojo_starter::models::Position\"];`\n        );\n    } catch (error) {\n        console.error(`Error generating types: ${error}`);\n        process.exit(1);\n    }\n}\n\nfunction collectAbis(generateTypes: boolean): void {\n    const dojoRoot = process.env.DOJO_ROOT || process.cwd();\n    const dojoEnv = process.env.DOJO_ENV || \"dev\";\n\n    const manifestPath = join(dojoRoot, `manifest_${dojoEnv}.json`);\n    const targetDir = join(dojoRoot, \"target\", dojoEnv);\n\n    const allAbis: AbiEntry[] = [];\n\n    // Read manifest file\n    if (!existsSync(manifestPath)) {\n        console.error(`Manifest file not found: ${manifestPath}`);\n        process.exit(1);\n    }\n\n    try {\n        const manifestContent = readFileSync(manifestPath, \"utf-8\");\n        const manifest: Manifest = JSON.parse(manifestContent);\n\n        // Extract ABIs from world\n        if (manifest.world?.abi) {\n            allAbis.push(...manifest.world.abi);\n        }\n\n        // Extract ABIs from contracts\n        if (manifest.contracts) {\n            for (const contract of manifest.contracts) {\n                if (contract.abi) {\n                    allAbis.push(...contract.abi);\n                }\n            }\n        }\n    } catch (error) {\n        console.error(`Error reading manifest file: ${error}`);\n        process.exit(1);\n    }\n\n    // Read target directory files\n    if (!existsSync(targetDir)) {\n        console.warn(`Target directory not found: ${targetDir}`);\n    } else {\n        try {\n            const files = readdirSync(targetDir).filter((file) =>\n                file.endsWith(\".json\")\n            );\n\n            for (const file of files) {\n                const filePath = join(targetDir, file);\n                try {\n                    const fileContent = readFileSync(filePath, \"utf-8\");\n                    const targetFile: TargetFile = JSON.parse(fileContent);\n\n                    // Extract only the abi key\n                    if (targetFile.abi) {\n                        allAbis.push(...targetFile.abi);\n                    }\n                } catch (error) {\n                    console.error(`Error reading file ${file}: ${error}`);\n                }\n            }\n        } catch (error) {\n            console.error(`Error reading target directory: ${error}`);\n        }\n    }\n\n    // Write output\n    const output = {\n        abi: allAbis,\n    };\n\n    const outputPath = join(dojoRoot, \"compiled-abi.json\");\n    writeFileSync(outputPath, JSON.stringify(output, null, 2));\n\n    console.log(`âœ… ABI compilation complete!`);\n    console.log(`ðŸ“„ Output written to: ${outputPath}`);\n    console.log(`ðŸ“Š Total ABI entries: ${allAbis.length}`);\n\n    // Generate TypeScript types if requested\n    if (generateTypes) {\n        generateAbiTypes(dojoRoot);\n    }\n}\n\n// Parse command line arguments\nconst args = process.argv.slice(2);\nconst generateTypes = args.includes(\"--generate-types\");\n\n// Run the compilation\ntry {\n    collectAbis(generateTypes);\n} catch (error) {\n    console.error(`Unexpected error: ${error}`);\n    process.exit(1);\n}\n"],"mappings":"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","names":["generateTypes"]}