import*as M from"@dojoengine/torii-wasm";import{err as $,ok as J}from"neverthrow";import{shortString as O}from"starknet";import{CairoCustomEnum as A,CairoOption as g,CairoOptionVariant as S}from"starknet";import{CairoCustomEnum as rt,CairoOption as U,CairoOptionVariant as x,addAddressPadding as st}from"starknet";import{addAddressPadding as R}from"starknet";import{err as ot,ok as ct}from"neverthrow";function v(t,e){if(Object.hasOwn(t,"type")&&Object.hasOwn(t,"value"))return{Primitive:{[t.type]:t.value}};if(typeof t=="number")return{Primitive:{U32:t}};if(typeof t=="boolean")return{Primitive:{Bool:t}};if(typeof t=="bigint")return{Primitive:{Felt252:e(t.toString())}};if(typeof t=="string")return{String:t};if(Array.isArray(t))return{List:t.map(r=>v(r,e))};throw new Error(`Unsupported primitive type: ${typeof t}`)}function ht(t,e,r="VariableLen"){return new h().keys(t,e,r)}function ft(t){return new h().hashed_keys(t)}function bt(t,e,r,s){return new h().where(t,e,r,s)}function kt(t){return new h().compose().and(t)}function Tt(t){return new h().compose().or(t)}var h=class{clause;constructor(){this.clause={}}keys(t,e,r="VariableLen"){return this.clause={Keys:{keys:e.length===0?[void 0]:e,pattern_matching:r,models:t}},this}hashed_keys(t){let e=t.map((r,s)=>{try{return`0x${BigInt(r).toString(16)}`}catch{throw new Error(`Invalid key value at index ${s}: ${r}. Expected a valid BigNumberish value.`)}});return this.clause={HashedKeys:e},this}where(t,e,r,s){let n=Array.isArray(s)?{List:s.map(c=>v(c,O.encodeShortString))}:v(s,O.encodeShortString);return this.clause={Member:{model:t,member:e,operator:r,value:n}},this}compose(){return new z}build(){if(Object.keys(this.clause).length===0)throw new Error("You cannot build an empty Clause");return this.clause}},z=class{orClauses=[];andClauses=[];or(t){return this.orClauses=t.map(e=>e.build()),this}and(t){return this.andClauses=t.map(e=>e.build()),this}build(){if(this.orClauses.length===0&&this.andClauses.length===0)throw new Error("ComposeClause is empty. Add .or([clause]) or .and([clause])");if(this.orClauses&&this.andClauses.length===0)return{Composite:{operator:"Or",clauses:this.orClauses}};if(this.andClauses&&this.orClauses.length===0)return{Composite:{operator:"And",clauses:this.andClauses}};if(this.andClauses&&this.orClauses)return{Composite:{operator:"And",clauses:[...this.andClauses,{Composite:{operator:"Or",clauses:this.orClauses}}]}};throw new Error("CompositeClause is not properly build")}},wt="No signer configured in sdk.init()",Ct="No identity configured in sdk.init()",P="Account is undefined",W="Clause has not been defined yet. Use `.withClause()` to do so";function G(t,e,r,s,n){return{types:{StarknetDomain:[{name:"name",type:"shortstring"},{name:"version",type:"shortstring"},{name:"chainId",type:"shortstring"},{name:"revision",type:"shortstring"}],...n,[t]:s!==void 0?s:Object.keys(e).map(c=>({name:c,type:typeof e[c]=="bigint"||typeof e[c]=="number"?"felt":"string"}))},primaryType:t,domain:r,message:e}}function D(t){return t instanceof g}function X(t,e){return e instanceof g&&e.isSome()?new g(S.Some,e.unwrap()):t instanceof g?t.isSome()?new g(S.Some,t.unwrap()):new g(S.None):t}function T(t){return t instanceof A}function Z(t,e){if(!T(t)||!T(e))return t;let r=e.activeVariant(),s=e.unwrap();if(r&&s!==void 0){let u={};for(let i in t.variant)u[i]=void 0;return u[r]=s,new A(u)}let n=t.activeVariant(),c=t.unwrap();if(n&&c!==void 0){let u={};for(let i in t.variant)u[i]=void 0;return u[n]=c,new A(u)}return t}function tt(t,e){if(D(t)&&D(e))return X(t,e);if(T(t)&&T(e))return Z(t,e);let r={...t};for(let s in e)Object.hasOwn(e,s)&&(e[s]!==null&&typeof e[s]=="object"&&!Array.isArray(e[s])&&s in t&&typeof t[s]=="object"&&!Array.isArray(t[s])?r[s]=tt(t[s],e[s]):r[s]=e[s]);return r}function vt(t,e,r){let[s,n]=e.split("-");for(let c of r)if(c.entityId===t)return c.models?.[s]?.[n]}function At(t,e){let[r,s]=t.split("-");for(let n of e)return n.models?.[r]?.[s]}var _={limit:1e3,cursor:void 0,direction:"Forward",order_by:[]},f=class q{constructor(e,r,s){this.limit=e,this.cursor=r,this.direction=s,this.items=[],s||(this.direction="Forward")}items;static fromQuery(e,r){let s=e.getPagination();return new q(s.limit??1e3,r,s.direction)}withItems(e){return this.items=e,this}getItems(){return this.items}getNextQuery(e){let r=e.withLimit(this.limit);return this.cursor&&r.withCursor(this.cursor),r.getPagination().direction!==this.direction&&r.withDirection(this.direction),r}getPreviousQuery(e){let r=e.withLimit(this.limit);return this.cursor&&r.withCursor(this.cursor),r.getPagination().direction===this.direction&&r.withDirection(et(this.direction)),r}};function et(t){return t==="Forward"?"Backward":"Forward"}function y(t,e){let r=[];for(let s of t){let n=st(s.hashed_keys),c=s.models,u={entityId:n,models:{}};for(let i in s.models){let[a,o]=i.split("-");if(!a||!o){e?.logging&&console.warn(`Invalid modelName format: ${i}`);continue}u.models[a]||(u.models[a]={}),u.models[a][o]=N(c[i])}r.push(u),e?.logging&&console.log("Parsed entity:",u)}return e?.logging&&console.log("Parsed result:",r),Object.values(r)}function w(t){switch(t.type){case"primitive":return nt(t);case"struct":return N(t.value);case"enum":return t.value.option==="Some"?new U(x.Some,w(t.value.value)):t.value.option==="None"?new U(x.None):it(t);case"tuple":case"array":return t.value.map(w);default:return t.value}}function it(t){return t.value.value.type==="tuple"?t.value.option:new rt({[t.value.option]:w(t.value.value)})}function nt(t){switch(t.type_name){case"u64":case"i64":return Number(t.value);case"u128":case"i128":return BigInt(t.value);case"u256":return BigInt(t.value);case"u8":case"u16":case"u32":case"i8":case"i16":case"i32":case"bool":case"ContractAddress":case"ClassHash":case"felt252":case"EthAddress":default:return t.value}}function N(t){let e=t instanceof Map?Array.from(t.entries()):Object.entries(t);return Object.fromEntries(e.map(([r,s])=>[r,w(s)]))}function B(t){return e=>{try{if(t){let r=y([e]);t({data:r,error:void 0})}}catch(r){t&&t({data:void 0,error:r instanceof Error?r:new Error(String(r))})}}}function m(t,e){return r=>{if(r!==e)try{t({data:r,error:void 0})}catch(s){t({data:void 0,error:s})}}}var b={balance:"0x0000000000000000000000000000000000000000000000000000000000000000",account_address:"0x0",contract_address:"0x0",token_id:"0x0000000000000000000000000000000000000000000000000000000000000000"};function l(t){return t.contractAddresses&&(t.contractAddresses=t.contractAddresses.map(e=>R(e))),t.accountAddresses&&(t.accountAddresses=t.accountAddresses.map(e=>R(e))),{contractAddresses:t.contractAddresses??[],accountAddresses:t.accountAddresses??[],attributesFilter:t.attributesFilter??[],contractTypes:t.contractTypes??[],tokenIds:t.tokenIds??[],pagination:t.pagination??_}}function at(t){return t.map(e=>({trait_name:e.name,trait_value:e.value}))}async function E(t,e){let{contractAddresses:r,tokenIds:s,pagination:n,attributesFilter:c}=l(e);return await t.getTokens({contract_addresses:r,token_ids:s,attribute_filters:at(c),pagination:n})}async function K(t,e){let{contractAddresses:r,contractTypes:s,pagination:n}=l(e);return await t.getTokenContracts({contract_addresses:r,contract_types:s,pagination:n})}async function I(t,e){let{contractAddresses:r,accountAddresses:s,tokenIds:n,pagination:c}=l(e);return await t.getTokenBalances({contract_addresses:r,account_addresses:s,token_ids:n,pagination:c})}async function Bt(t,e){let{contractAddresses:r,accountAddresses:s,tokenIds:n}=l(e);return await t.onTokenBalanceUpdated(r??[],s??[],n??[],m(e.callback,b))}async function Q(t,e){let{subscription:r,contractAddresses:s,accountAddresses:n,tokenIds:c}=e;return await t.updateTokenBalanceSubscription(r,s??[],n??[],c??[])}async function j(t,e){let{contractAddresses:r,accountAddresses:s,tokenIds:n,callback:c}=e,u=await I(t,{contractAddresses:r??[],accountAddresses:s??[],tokenIds:n??[]}),i=await t.onTokenBalanceUpdated(r??[],s??[],n??[],m(c,b));return[u,i]}var k={contract_address:"0x0",token_id:"0x0000000000000000000000000000000000000000000000000000000000000000",name:"",symbol:"",decimals:0,metadata:"",total_supply:""};async function Et(t,e){let{contractAddresses:r,tokenIds:s,callback:n}=l(e);return await t.onTokenUpdated(r??[],s??[],m(n,k))}async function F(t,e){let{contractAddresses:r,tokenIds:s,callback:n}=e,c=await E(t,{contractAddresses:r??[],tokenIds:s??[]}),u=await t.onTokenUpdated(r??[],s??[],m(n,k));return[c,u]}var L=()=>({pagination:{limit:100,cursor:void 0,direction:"Forward",order_by:[]},clause:void 0,no_hashed_keys:!0,models:[],historical:!1}),ut=class V{query;constructor(e){this.query={...L(),...e}}withLimit(e){return this.query.pagination.limit=e,this}withOffset(){return this}withCursor(e){return this.query.pagination.cursor=e,this}withDirection(e){return this.query.pagination.direction=e,this}withClause(e){return this.query.clause=e,this}includeHashedKeys(){return this.query.no_hashed_keys=!1,this}addOrderBy(e,r){return this.query.pagination.order_by.push({field:e,direction:r}),this}withOrderBy(e){return this.query.pagination.order_by=e,this}addEntityModel(e){return this.query.models.push(e),this}withEntityModels(e){return this.query.models=e,this}build(){return this.query}static withPagination(e,r,s){return new V().withLimit(r).withCursor(e).withDirection(s)}getClause(){return this.query.clause?ct(this.query.clause):ot(W)}getPagination(){return this.query.pagination}isHistorical(){return this.query.historical}},Mt=class extends ut{constructor(t){super({...L(),...t,historical:!0})}};import{ok as dt}from"neverthrow";import{ToriiGrpcClient as lt}from"@dojoengine/grpc";function H({client:t,config:e,sendMessage:r,sendMessageBatch:s,grpcClient:n}){let c=n??t;if(!c)throw new Error("Either client or grpcClient must be provided");let u=n??new lt({toriiUrl:e.client.toriiUrl??"http://localhost:8080",worldAddress:e.client.worldAddress});return{client:t,subscribeEntityQuery:async({query:i,callback:a})=>{let o=i.build(),d=await c.getEntities(o),p=y(d.items);return[f.fromQuery(i,d.next_cursor).withItems(p),await c.onEntityUpdated(o.clause,B(a))]},subscribeEventQuery:async({query:i,callback:a})=>{let o=i.build(),d=await u.getEventMessages(o),p=y(d.items);return[f.fromQuery(i,d.next_cursor).withItems(p),await u.onEventMessageUpdated(o.clause,B(a))]},subscribeTokenBalance:async i=>{if(n){let{contractAddresses:a,accountAddresses:o,tokenIds:d,pagination:p}=l(i),C=await n.getTokenBalances({contract_addresses:a,account_addresses:o,token_ids:d,pagination:p}),Y=await n.onTokenBalanceUpdated(a??[],o??[],d??[],m(i.callback,b));return[C,Y]}return await j(t,i)},getEntities:async({query:i})=>{let a=i.build(),o=await c.getEntities(a);return f.fromQuery(i,o.next_cursor).withItems(y(o.items))},getEventMessages:async({query:i})=>{let a=i.build(),o=await c.getEventMessages(a);return f.fromQuery(i,o.next_cursor).withItems(y(o.items))},generateTypedData:(i,a,o,d)=>G(i,a,e.domain,o,d),sendMessage:r,sendMessageBatch:s,sendSignedMessageBatch:async i=>{try{return dt(await c.publishMessageBatch(i))}catch(a){throw console.error("Failed to send signed message batch:",a),a}},getTokens:async i=>{if(n){let{contractAddresses:a,tokenIds:o,pagination:d}=l(i);return await n.getTokens({contract_addresses:a,token_ids:o,pagination:d})}return await E(t,i)},getTokenContracts:async i=>{if(n){let{contractAddresses:a,contractTypes:o,pagination:d}=l(i);return await n.getTokenContracts({contract_addresses:a,contract_types:o,pagination:d})}return await K(t,i)},getTokenBalances:async i=>{if(n){let{contractAddresses:a,accountAddresses:o,tokenIds:d,pagination:p}=l(i);return await n.getTokenBalances({contract_addresses:a,account_addresses:o,token_ids:d,pagination:p})}return await I(t,i)},onTokenBalanceUpdated:async i=>{let{contractAddresses:a,accountAddresses:o,tokenIds:d}=l(i);return await u.onTokenBalanceUpdated(a??[],o??[],d??[],m(i.callback,b))},onTokenUpdated:async i=>{let{contractAddresses:a,tokenIds:o}=l(i);return await u.onTokenUpdated(a??[],o??[],m(i.callback,k))},updateTokenBalanceSubscription:async i=>{if(n){let{contractAddresses:a,accountAddresses:o,tokenIds:d}=l(i);return await n.updateTokenBalanceSubscription(i.subscription,a??[],o??[],d??[])}return await Q(t,i)},updateEntitySubscription:async(i,a)=>await c.updateEntitySubscription(i,a),updateEventMessageSubscription:async(i,a,o)=>await u.updateEventMessageSubscription(i,a),getControllers:async(i,a,o=_)=>await c.getControllers({contract_addresses:i,usernames:a,pagination:o}),subscribeToken:async i=>{if(n){let{contractAddresses:a,tokenIds:o,pagination:d}=l(i),p=await n.getTokens({contract_addresses:a,token_ids:o,pagination:d}),C=await n.onTokenUpdated(a??[],o??[],m(i.callback,k));return[p,C]}return await F(t,i)}}}import{ToriiGrpcClient as pt}from"@dojoengine/grpc";function mt(t){return new pt({toriiUrl:t.toriiUrl??"http://localhost:8080",worldAddress:t.worldAddress})}async function Vt(t){return await new M.ToriiClient(t)}var gt={toriiUrl:"http://localhost:8080"};async function Ht(t){let e;if(!t.grpcClient){let n={...gt,...t.client};e=await new M.ToriiClient(n)}return H({client:e,config:t,sendMessage:async(n,c)=>{if(!c)return $(P);try{let u=await c.signMessage(n),i=JSON.stringify(n),a=t.grpcClient||e;return J(await a.publishMessage({message:i,signature:Array.isArray(u)?u:[u.r.toString(),u.s.toString()]}))}catch(u){throw console.error("Failed to send message:",u),u}},sendMessageBatch:async(n,c)=>{if(!c)return $(P);try{let u=[];for(let a of n){let o=await c.signMessage(a),d=JSON.stringify(a);u.push({message:d,signature:Array.isArray(o)?o:[o.r.toString(),o.s.toString()]})}let i=t.grpcClient||e;return J(await i.publishMessageBatch(u))}catch(u){throw console.error("Failed to send message batch:",u),u}},grpcClient:t.grpcClient})}export{v as a,ht as b,ft as c,bt as d,kt as e,Tt as f,h as g,wt as h,Ct as i,P as j,W as k,G as l,D as m,X as n,T as o,Z as p,tt as q,vt as r,At as s,_ as t,f as u,y as v,B as w,m as x,b as y,l as z,E as A,K as B,I as C,Bt as D,Q as E,j as F,k as G,Et as H,F as I,ut as J,Mt as K,mt as L,Vt as M,gt as N,Ht as O};
//# sourceMappingURL=chunk-T6XYST2Q.js.map