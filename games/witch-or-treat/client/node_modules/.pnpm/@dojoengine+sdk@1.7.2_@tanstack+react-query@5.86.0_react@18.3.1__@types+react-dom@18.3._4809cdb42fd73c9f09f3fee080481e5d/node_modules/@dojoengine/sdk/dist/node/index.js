import*as Y from"@dojoengine/torii-wasm/node";import{err as f,ok as W}from"neverthrow";import{shortString as O}from"starknet";import{CairoCustomEnum as _,CairoOption as g,CairoOptionVariant as A}from"starknet";import{CairoCustomEnum as se,CairoOption as U,CairoOptionVariant as R,addAddressPadding as ie}from"starknet";import{addAddressPadding as G}from"starknet";import{err as ce,ok as ue}from"neverthrow";function P(e,t){if(Object.hasOwn(e,"type")&&Object.hasOwn(e,"value"))return{Primitive:{[e.type]:e.value}};if(typeof e=="number")return{Primitive:{U32:e}};if(typeof e=="boolean")return{Primitive:{Bool:e}};if(typeof e=="bigint")return{Primitive:{Felt252:t(e.toString())}};if(typeof e=="string")return{String:e};if(Array.isArray(e))return{List:e.map(r=>P(r,t))};throw new Error(`Unsupported primitive type: ${typeof e}`)}function he(e,t,r="VariableLen"){return new h().keys(e,t,r)}function be(e){return new h().hashed_keys(e)}function ke(e,t,r,s){return new h().where(e,t,r,s)}function Te(e){return new h().compose().and(e)}function we(e){return new h().compose().or(e)}var h=class{clause;constructor(){this.clause={}}keys(e,t,r="VariableLen"){return this.clause={Keys:{keys:t.length===0?[void 0]:t,pattern_matching:r,models:e}},this}hashed_keys(e){let t=e.map((r,s)=>{try{return`0x${BigInt(r).toString(16)}`}catch{throw new Error(`Invalid key value at index ${s}: ${r}. Expected a valid BigNumberish value.`)}});return this.clause={HashedKeys:t},this}where(e,t,r,s){let n=Array.isArray(s)?{List:s.map(c=>P(c,O.encodeShortString))}:P(s,O.encodeShortString);return this.clause={Member:{model:e,member:t,operator:r,value:n}},this}compose(){return new z}build(){if(Object.keys(this.clause).length===0)throw new Error("You cannot build an empty Clause");return this.clause}},z=class{orClauses=[];andClauses=[];or(e){return this.orClauses=e.map(t=>t.build()),this}and(e){return this.andClauses=e.map(t=>t.build()),this}build(){if(this.orClauses.length===0&&this.andClauses.length===0)throw new Error("ComposeClause is empty. Add .or([clause]) or .and([clause])");if(this.orClauses&&this.andClauses.length===0)return{Composite:{operator:"Or",clauses:this.orClauses}};if(this.andClauses&&this.orClauses.length===0)return{Composite:{operator:"And",clauses:this.andClauses}};if(this.andClauses&&this.orClauses)return{Composite:{operator:"And",clauses:[...this.andClauses,{Composite:{operator:"Or",clauses:this.orClauses}}]}};throw new Error("CompositeClause is not properly build")}},B="No signer configured in sdk.init()",b="No identity configured in sdk.init()",Ce="Account is undefined",X="Clause has not been defined yet. Use `.withClause()` to do so";function N(e,t,r,s,n){return{types:{StarknetDomain:[{name:"name",type:"shortstring"},{name:"version",type:"shortstring"},{name:"chainId",type:"shortstring"},{name:"revision",type:"shortstring"}],...n,[e]:s!==void 0?s:Object.keys(t).map(c=>({name:c,type:typeof t[c]=="bigint"||typeof t[c]=="number"?"felt":"string"}))},primaryType:e,domain:r,message:t}}function x(e){return e instanceof g}function Z(e,t){return t instanceof g&&t.isSome()?new g(A.Some,t.unwrap()):e instanceof g?e.isSome()?new g(A.Some,e.unwrap()):new g(A.None):e}function C(e){return e instanceof _}function ee(e,t){if(!C(e)||!C(t))return e;let r=t.activeVariant(),s=t.unwrap();if(r&&s!==void 0){let u={};for(let i in e.variant)u[i]=void 0;return u[r]=s,new _(u)}let n=e.activeVariant(),c=e.unwrap();if(n&&c!==void 0){let u={};for(let i in e.variant)u[i]=void 0;return u[n]=c,new _(u)}return e}function te(e,t){if(x(e)&&x(t))return Z(e,t);if(C(e)&&C(t))return ee(e,t);let r={...e};for(let s in t)Object.hasOwn(t,s)&&(t[s]!==null&&typeof t[s]=="object"&&!Array.isArray(t[s])&&s in e&&typeof e[s]=="object"&&!Array.isArray(e[s])?r[s]=te(e[s],t[s]):r[s]=t[s]);return r}function ve(e,t,r){let[s,n]=t.split("-");for(let c of r)if(c.entityId===e)return c.models?.[s]?.[n]}function Ae(e,t){let[r,s]=e.split("-");for(let n of t)return n.models?.[r]?.[s]}var I={limit:1e3,cursor:void 0,direction:"Forward",order_by:[]},k=class q{constructor(t,r,s){this.limit=t,this.cursor=r,this.direction=s,this.items=[],s||(this.direction="Forward")}items;static fromQuery(t,r){let s=t.getPagination();return new q(s.limit??1e3,r,s.direction)}withItems(t){return this.items=t,this}getItems(){return this.items}getNextQuery(t){let r=t.withLimit(this.limit);return this.cursor&&r.withCursor(this.cursor),r.getPagination().direction!==this.direction&&r.withDirection(this.direction),r}getPreviousQuery(t){let r=t.withLimit(this.limit);return this.cursor&&r.withCursor(this.cursor),r.getPagination().direction===this.direction&&r.withDirection(re(this.direction)),r}};function re(e){return e==="Forward"?"Backward":"Forward"}function y(e,t){let r=[];for(let s of e){let n=ie(s.hashed_keys),c=s.models,u={entityId:n,models:{}};for(let i in s.models){let[a,o]=i.split("-");if(!a||!o){t?.logging&&console.warn(`Invalid modelName format: ${i}`);continue}u.models[a]||(u.models[a]={}),u.models[a][o]=K(c[i])}r.push(u),t?.logging&&console.log("Parsed entity:",u)}return t?.logging&&console.log("Parsed result:",r),Object.values(r)}function S(e){switch(e.type){case"primitive":return ae(e);case"struct":return K(e.value);case"enum":return e.value.option==="Some"?new U(R.Some,S(e.value.value)):e.value.option==="None"?new U(R.None):ne(e);case"tuple":case"array":return e.value.map(S);default:return e.value}}function ne(e){return e.value.value.type==="tuple"?e.value.option:new se({[e.value.option]:S(e.value.value)})}function ae(e){switch(e.type_name){case"u64":case"i64":return Number(e.value);case"u128":case"i128":return BigInt(e.value);case"u256":return BigInt(e.value);case"u8":case"u16":case"u32":case"i8":case"i16":case"i32":case"bool":case"ContractAddress":case"ClassHash":case"felt252":case"EthAddress":default:return e.value}}function K(e){let t=e instanceof Map?Array.from(e.entries()):Object.entries(e);return Object.fromEntries(t.map(([r,s])=>[r,S(s)]))}function E(e){return t=>{try{if(e){let r=y([t]);e({data:r,error:void 0})}}catch(r){e&&e({data:void 0,error:r instanceof Error?r:new Error(String(r))})}}}function m(e,t){return r=>{if(r!==t)try{e({data:r,error:void 0})}catch(s){e({data:void 0,error:s})}}}var T={balance:"0x0000000000000000000000000000000000000000000000000000000000000000",account_address:"0x0",contract_address:"0x0",token_id:"0x0000000000000000000000000000000000000000000000000000000000000000"};function l(e){return e.contractAddresses&&(e.contractAddresses=e.contractAddresses.map(t=>G(t))),e.accountAddresses&&(e.accountAddresses=e.accountAddresses.map(t=>G(t))),{contractAddresses:e.contractAddresses??[],accountAddresses:e.accountAddresses??[],attributesFilter:e.attributesFilter??[],contractTypes:e.contractTypes??[],tokenIds:e.tokenIds??[],pagination:e.pagination??I}}function oe(e){return e.map(t=>({trait_name:t.name,trait_value:t.value}))}async function M(e,t){let{contractAddresses:r,tokenIds:s,pagination:n,attributesFilter:c}=l(t);return await e.getTokens({contract_addresses:r,token_ids:s,attribute_filters:oe(c),pagination:n})}async function j(e,t){let{contractAddresses:r,contractTypes:s,pagination:n}=l(t);return await e.getTokenContracts({contract_addresses:r,contract_types:s,pagination:n})}async function D(e,t){let{contractAddresses:r,accountAddresses:s,tokenIds:n,pagination:c}=l(t);return await e.getTokenBalances({contract_addresses:r,account_addresses:s,token_ids:n,pagination:c})}async function Be(e,t){let{contractAddresses:r,accountAddresses:s,tokenIds:n}=l(t);return await e.onTokenBalanceUpdated(r??[],s??[],n??[],m(t.callback,T))}async function Q(e,t){let{subscription:r,contractAddresses:s,accountAddresses:n,tokenIds:c}=t;return await e.updateTokenBalanceSubscription(r,s??[],n??[],c??[])}async function F(e,t){let{contractAddresses:r,accountAddresses:s,tokenIds:n,callback:c}=t,u=await D(e,{contractAddresses:r??[],accountAddresses:s??[],tokenIds:n??[]}),i=await e.onTokenBalanceUpdated(r??[],s??[],n??[],m(c,T));return[u,i]}var w={contract_address:"0x0",token_id:"0x0000000000000000000000000000000000000000000000000000000000000000",name:"",symbol:"",decimals:0,metadata:"",total_supply:""};async function Ie(e,t){let{contractAddresses:r,tokenIds:s,callback:n}=l(t);return await e.onTokenUpdated(r??[],s??[],m(n,w))}async function L(e,t){let{contractAddresses:r,tokenIds:s,callback:n}=t,c=await M(e,{contractAddresses:r??[],tokenIds:s??[]}),u=await e.onTokenUpdated(r??[],s??[],m(n,w));return[c,u]}var V=()=>({pagination:{limit:100,cursor:void 0,direction:"Forward",order_by:[]},clause:void 0,no_hashed_keys:!0,models:[],historical:!1}),de=class H{query;constructor(t){this.query={...V(),...t}}withLimit(t){return this.query.pagination.limit=t,this}withOffset(){return this}withCursor(t){return this.query.pagination.cursor=t,this}withDirection(t){return this.query.pagination.direction=t,this}withClause(t){return this.query.clause=t,this}includeHashedKeys(){return this.query.no_hashed_keys=!1,this}addOrderBy(t,r){return this.query.pagination.order_by.push({field:t,direction:r}),this}withOrderBy(t){return this.query.pagination.order_by=t,this}addEntityModel(t){return this.query.models.push(t),this}withEntityModels(t){return this.query.models=t,this}build(){return this.query}static withPagination(t,r,s){return new H().withLimit(r).withCursor(t).withDirection(s)}getClause(){return this.query.clause?ue(this.query.clause):ce(X)}getPagination(){return this.query.pagination}isHistorical(){return this.query.historical}},Me=class extends de{constructor(e){super({...V(),...e,historical:!0})}};import{ok as le}from"neverthrow";import{ToriiGrpcClient as pe}from"@dojoengine/grpc";function $({client:e,config:t,sendMessage:r,sendMessageBatch:s,grpcClient:n}){let c=n??e;if(!c)throw new Error("Either client or grpcClient must be provided");let u=n??new pe({toriiUrl:t.client.toriiUrl??"http://localhost:8080",worldAddress:t.client.worldAddress});return{client:e,subscribeEntityQuery:async({query:i,callback:a})=>{let o=i.build(),d=await c.getEntities(o),p=y(d.items);return[k.fromQuery(i,d.next_cursor).withItems(p),await c.onEntityUpdated(o.clause,E(a))]},subscribeEventQuery:async({query:i,callback:a})=>{let o=i.build(),d=await u.getEventMessages(o),p=y(d.items);return[k.fromQuery(i,d.next_cursor).withItems(p),await u.onEventMessageUpdated(o.clause,E(a))]},subscribeTokenBalance:async i=>{if(n){let{contractAddresses:a,accountAddresses:o,tokenIds:d,pagination:p}=l(i),v=await n.getTokenBalances({contract_addresses:a,account_addresses:o,token_ids:d,pagination:p}),J=await n.onTokenBalanceUpdated(a??[],o??[],d??[],m(i.callback,T));return[v,J]}return await F(e,i)},getEntities:async({query:i})=>{let a=i.build(),o=await c.getEntities(a);return k.fromQuery(i,o.next_cursor).withItems(y(o.items))},getEventMessages:async({query:i})=>{let a=i.build(),o=await c.getEventMessages(a);return k.fromQuery(i,o.next_cursor).withItems(y(o.items))},generateTypedData:(i,a,o,d)=>N(i,a,t.domain,o,d),sendMessage:r,sendMessageBatch:s,sendSignedMessageBatch:async i=>{try{return le(await c.publishMessageBatch(i))}catch(a){throw console.error("Failed to send signed message batch:",a),a}},getTokens:async i=>{if(n){let{contractAddresses:a,tokenIds:o,pagination:d}=l(i);return await n.getTokens({contract_addresses:a,token_ids:o,pagination:d})}return await M(e,i)},getTokenContracts:async i=>{if(n){let{contractAddresses:a,contractTypes:o,pagination:d}=l(i);return await n.getTokenContracts({contract_addresses:a,contract_types:o,pagination:d})}return await j(e,i)},getTokenBalances:async i=>{if(n){let{contractAddresses:a,accountAddresses:o,tokenIds:d,pagination:p}=l(i);return await n.getTokenBalances({contract_addresses:a,account_addresses:o,token_ids:d,pagination:p})}return await D(e,i)},onTokenBalanceUpdated:async i=>{let{contractAddresses:a,accountAddresses:o,tokenIds:d}=l(i);return await u.onTokenBalanceUpdated(a??[],o??[],d??[],m(i.callback,T))},onTokenUpdated:async i=>{let{contractAddresses:a,tokenIds:o}=l(i);return await u.onTokenUpdated(a??[],o??[],m(i.callback,w))},updateTokenBalanceSubscription:async i=>{if(n){let{contractAddresses:a,accountAddresses:o,tokenIds:d}=l(i);return await n.updateTokenBalanceSubscription(i.subscription,a??[],o??[],d??[])}return await Q(e,i)},updateEntitySubscription:async(i,a)=>await c.updateEntitySubscription(i,a),updateEventMessageSubscription:async(i,a,o)=>await u.updateEventMessageSubscription(i,a),getControllers:async(i,a,o=I)=>await c.getControllers({contract_addresses:i,usernames:a,pagination:o}),subscribeToken:async i=>{if(n){let{contractAddresses:a,tokenIds:o,pagination:d}=l(i),p=await n.getTokens({contract_addresses:a,token_ids:o,pagination:d}),v=await n.onTokenUpdated(a??[],o??[],m(i.callback,w));return[p,v]}return await L(e,i)}}}async function Ke(e){let t=await e();process.on("SIGTERM",()=>{for(let r of t)r.free();process.exit(0)}),process.on("SIGINT",()=>{for(let r of t)r.free();process.exit(0)})}import{ToriiGrpcClient as me}from"@dojoengine/grpc";function ge(e){return new me({toriiUrl:e.toriiUrl??"http://localhost:8080",worldAddress:e.worldAddress})}var ye={toriiUrl:"http://localhost:8080"};async function $e(e){let t;if(!e.grpcClient){let n={...ye,...e.client};t=await new Y.ToriiClient(n)}return $({client:t,config:e,sendMessage:async(n,c)=>{if(!e.signer)return f(B);if(!e.identity)return f(b);if(!c)return f(b);try{let u=await c.signMessage(n),i=JSON.stringify(n),a=e.grpcClient||t;return W(await a.publishMessage({message:i,signature:Array.isArray(u)?u:[u.r.toString(),u.s.toString()]}))}catch(u){throw console.error("Failed to send message:",u),u}},sendMessageBatch:async(n,c)=>{if(!e.signer)return f(B);if(!e.identity)return f(b);if(!c)return f(b);try{let u=[];for(let a of n){let o=await c.signMessage(a),d=JSON.stringify(a);u.push({message:d,signature:Array.isArray(o)?o:[o.r.toString(),o.s.toString()]})}let i=e.grpcClient||t;return W(await i.publishMessageBatch(u))}catch(u){throw console.error("Failed to send message batch:",u),u}},grpcClient:e.grpcClient})}export{Te as AndComposeClause,h as ClauseBuilder,be as HashedKeysClause,Me as HistoricalToriiQueryBuilder,he as KeysClause,ke as MemberClause,Ce as NO_ACCOUNT,b as NO_IDENTITY,B as NO_SIGNER,we as OrComposeClause,k as Pagination,de as ToriiQueryBuilder,X as UNDEFINED_CLAUSE,P as convertToPrimitive,Ke as createWorker,te as deepMerge,ye as defaultClientConfig,w as defaultToken,T as defaultTokenBalance,I as defaultToriiPagination,N as generateTypedData,Ae as getModel,ve as getModelByEntityId,D as getTokenBalances,j as getTokenContracts,M as getTokens,$e as init,ge as initGrpc,C as isCairoCustomEnum,x as isCairoOption,ee as mergeCairoCustomEnum,Z as mergeCairoOption,Be as onTokenBalanceUpdated,Ie as onTokenUpdated,y as parseEntities,l as parseTokenRequest,m as safeCallback,E as subscribeQueryModelCallback,L as subscribeToken,F as subscribeTokenBalance,Q as updateTokenBalanceSubscription};
//# sourceMappingURL=index.js.map